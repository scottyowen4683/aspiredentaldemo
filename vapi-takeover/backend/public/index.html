<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aspire AI Platform - Admin Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .sidebar-item { transition: all 0.2s; }
    .sidebar-item:hover { background: rgba(255,255,255,0.1); }
    .sidebar-item.active { background: rgba(255,255,255,0.2); border-left: 3px solid white; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; }
    .modal.active { display: flex; }
    .toast { animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <aside class="fixed left-0 top-0 h-full w-64 gradient-bg text-white z-40">
    <div class="p-6 border-b border-white/20">
      <h1 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-robot"></i> Aspire AI</h1>
      <p class="text-sm opacity-75 mt-1">Admin Portal</p>
    </div>
    <nav class="p-4">
      <div class="sidebar-item active rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="dashboard"><i class="fas fa-chart-line w-5"></i> Dashboard</div>
      <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="organizations"><i class="fas fa-building w-5"></i> Organizations</div>
      <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="assistants"><i class="fas fa-headset w-5"></i> Assistants</div>
      <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="knowledge"><i class="fas fa-book w-5"></i> Knowledge Base</div>
      <div class="sidebar-item rounded-lg px-4 py-3 cursor-pointer flex items-center gap-3" data-page="chat"><i class="fas fa-comments w-5"></i> Test Chat</div>
    </nav>
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-white/20">
      <div class="text-xs opacity-75">
        <p>Status: <span id="backendStatus" class="text-green-300">Connected</span></p>
        <p class="mt-1">No VAPI dependency</p>
      </div>
    </div>
  </aside>

  <main class="ml-64 p-8">
    <!-- Dashboard -->
    <div id="page-dashboard" class="page">
      <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card p-6"><div class="flex items-center justify-between"><div><p class="text-gray-500 text-sm">Organizations</p><p class="text-3xl font-bold" id="stat-orgs">0</p></div><div class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center"><i class="fas fa-building text-white"></i></div></div></div>
        <div class="card p-6"><div class="flex items-center justify-between"><div><p class="text-gray-500 text-sm">Assistants</p><p class="text-3xl font-bold" id="stat-assistants">0</p></div><div class="w-12 h-12 rounded-full bg-green-500 flex items-center justify-center"><i class="fas fa-headset text-white"></i></div></div></div>
        <div class="card p-6"><div class="flex items-center justify-between"><div><p class="text-gray-500 text-sm">Conversations</p><p class="text-3xl font-bold" id="stat-conversations">0</p></div><div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center"><i class="fas fa-comments text-white"></i></div></div></div>
        <div class="card p-6"><div class="flex items-center justify-between"><div><p class="text-gray-500 text-sm">This Month</p><p class="text-3xl font-bold" id="stat-monthly">$0</p></div><div class="w-12 h-12 rounded-full bg-yellow-500 flex items-center justify-center"><i class="fas fa-dollar-sign text-white"></i></div></div></div>
      </div>
      <div class="card p-6">
        <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
        <div class="flex gap-4 flex-wrap">
          <button onclick="showModal('org-modal')" class="px-4 py-2 gradient-bg text-white rounded-lg hover:opacity-90"><i class="fas fa-plus mr-2"></i>New Organization</button>
          <button onclick="showModal('assistant-modal')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:opacity-90"><i class="fas fa-plus mr-2"></i>New Assistant</button>
          <button onclick="navigateTo('knowledge')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:opacity-90"><i class="fas fa-upload mr-2"></i>Upload Knowledge</button>
        </div>
      </div>
    </div>

    <!-- Organizations -->
    <div id="page-organizations" class="page hidden">
      <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Organizations</h2><button onclick="showModal('org-modal')" class="px-4 py-2 gradient-bg text-white rounded-lg"><i class="fas fa-plus mr-2"></i>New Organization</button></div>
      <div class="card"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Slug</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monthly Fee</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">UUID</th></tr></thead><tbody id="orgs-table" class="divide-y divide-gray-200"></tbody></table></div>
    </div>

    <!-- Assistants -->
    <div id="page-assistants" class="page hidden">
      <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Assistants</h2><button onclick="showModal('assistant-modal')" class="px-4 py-2 gradient-bg text-white rounded-lg"><i class="fas fa-plus mr-2"></i>New Assistant</button></div>
      <div class="card"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Model</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">UUID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="assistants-table" class="divide-y divide-gray-200"></tbody></table></div>
    </div>

    <!-- Knowledge Base -->
    <div id="page-knowledge" class="page hidden">
      <h2 class="text-2xl font-bold mb-6">Knowledge Base</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
          <h3 class="text-lg font-semibold mb-4"><i class="fas fa-file-upload mr-2"></i>Upload File</h3>
          <form id="kb-upload-form">
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Organization</label><select id="kb-org-select" class="w-full border rounded-lg px-4 py-2" required><option value="">Select...</option></select></div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">File (TXT, PDF, DOCX)</label><div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-purple-500" id="drop-zone"><i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i><p class="text-gray-500">Drag & drop or click</p><input type="file" id="kb-file" class="hidden" accept=".txt,.pdf,.docx"><p id="file-name" class="text-sm text-purple-600 mt-2"></p></div></div>
            <button type="submit" class="w-full py-2 gradient-bg text-white rounded-lg"><i class="fas fa-upload mr-2"></i>Upload & Process</button>
          </form>
        </div>
        <div class="card p-6">
          <h3 class="text-lg font-semibold mb-4"><i class="fas fa-paste mr-2"></i>Paste Text</h3>
          <form id="kb-text-form">
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Organization</label><select id="kb-text-org-select" class="w-full border rounded-lg px-4 py-2" required><option value="">Select...</option></select></div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Title</label><input type="text" id="kb-title" class="w-full border rounded-lg px-4 py-2" placeholder="FAQ Document"></div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Content</label><textarea id="kb-text" class="w-full border rounded-lg px-4 py-2 h-32" required></textarea></div>
            <button type="submit" class="w-full py-2 gradient-bg text-white rounded-lg"><i class="fas fa-save mr-2"></i>Save & Process</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Test Chat -->
    <div id="page-chat" class="page hidden">
      <h2 class="text-2xl font-bold mb-6">Test Chat</h2>
      <div class="card">
        <div class="p-4 border-b flex gap-4 items-end">
          <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-2">Select Assistant</label><select id="chat-assistant-select" class="w-full border rounded-lg px-4 py-2"><option value="">Select...</option></select></div>
          <button onclick="startNewChat()" class="px-4 py-2 bg-gray-200 rounded-lg"><i class="fas fa-redo mr-2"></i>New Chat</button>
        </div>
        <div id="chat-messages" class="p-4 h-96 overflow-y-auto space-y-4 bg-gray-50"><p class="text-center text-gray-500">Select an assistant to start</p></div>
        <div class="p-4 border-t flex gap-2">
          <input type="text" id="chat-input" class="flex-1 border rounded-lg px-4 py-2" placeholder="Type message..." onkeypress="if(event.key==='Enter')sendChat()">
          <button onclick="sendChat()" class="px-6 py-2 gradient-bg text-white rounded-lg"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div class="px-4 pb-4 text-sm text-gray-500">Session: <span id="chat-session">-</span> | Cost: $<span id="chat-cost">0.000</span></div>
      </div>
    </div>
  </main>

  <!-- Organization Modal -->
  <div id="org-modal" class="modal items-center justify-center">
    <div class="card w-full max-w-lg mx-4">
      <div class="p-6 border-b flex justify-between items-center"><h3 class="text-xl font-bold">Create Organization</h3><button onclick="hideModal('org-modal')" class="text-gray-500"><i class="fas fa-times"></i></button></div>
      <form id="org-form" class="p-6">
        <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Name *</label><input type="text" id="org-name" class="w-full border rounded-lg px-4 py-2" required></div>
        <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Slug *</label><input type="text" id="org-slug" class="w-full border rounded-lg px-4 py-2" required></div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Monthly Fee ($)</label><input type="number" id="org-fee" class="w-full border rounded-lg px-4 py-2" value="500"></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Included Interactions</label><input type="number" id="org-included" class="w-full border rounded-lg px-4 py-2" value="5000"></div>
        </div>
        <button type="submit" class="w-full py-3 gradient-bg text-white rounded-lg font-semibold">Create Organization</button>
      </form>
    </div>
  </div>

  <!-- Assistant Modal -->
  <div id="assistant-modal" class="modal items-center justify-center">
    <div class="card w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex justify-between items-center"><h3 class="text-xl font-bold">Create Assistant</h3><button onclick="hideModal('assistant-modal')" class="text-gray-500"><i class="fas fa-times"></i></button></div>
      <form id="assistant-form" class="p-6">
        <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Organization *</label><select id="assistant-org" class="w-full border rounded-lg px-4 py-2" required><option value="">Select...</option></select></div>
        <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Name *</label><input type="text" id="assistant-name" class="w-full border rounded-lg px-4 py-2" required></div>
        <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Type *</label><div class="flex gap-4"><label class="flex items-center gap-2"><input type="radio" name="bot-type" value="chat" checked onchange="toggleVoice()"><span class="px-4 py-2 border rounded-lg">Chat</span></label><label class="flex items-center gap-2"><input type="radio" name="bot-type" value="voice" onchange="toggleVoice()"><span class="px-4 py-2 border rounded-lg">Voice</span></label></div></div>
        <div id="voice-fields" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
          <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Twilio Phone *</label><div class="flex gap-2"><input type="text" id="assistant-phone" class="flex-1 border rounded-lg px-4 py-2" placeholder="+61..."><button type="button" onclick="validatePhone()" class="px-4 py-2 bg-blue-500 text-white rounded-lg">Validate</button></div><p id="phone-status" class="text-sm mt-1"></p></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">ElevenLabs Voice ID</label><input type="text" id="assistant-voice" class="w-full border rounded-lg px-4 py-2" placeholder="Optional"></div>
        </div>
        <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Model</label><select id="assistant-model" class="w-full border rounded-lg px-4 py-2"><option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option><option value="gpt-4o">GPT-4o</option></select></div>
        <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">System Prompt *</label><textarea id="assistant-prompt" class="w-full border rounded-lg px-4 py-2 h-32" required></textarea></div>
        <button type="submit" class="w-full py-3 gradient-bg text-white rounded-lg font-semibold">Create Assistant</button>
      </form>
    </div>
  </div>

  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    const API = window.location.origin + '/api';
    let chatSessionId = null, chatCost = 0, orgsCache = [], assistantsCache = [];

    document.querySelectorAll('.sidebar-item').forEach(item => {
      item.addEventListener('click', () => navigateTo(item.dataset.page));
    });

    function navigateTo(page) {
      document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(`page-${page}`)?.classList.remove('hidden');
      if (page === 'dashboard') loadStats();
      if (page === 'organizations') loadOrgs();
      if (page === 'assistants') loadAssistants();
      if (page === 'knowledge') loadOrgSelects();
      if (page === 'chat') loadChatAssistants();
    }

    function showToast(msg, type = 'success') {
      const t = document.createElement('div');
      t.className = `toast px-6 py-3 rounded-lg shadow-lg ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white`;
      t.textContent = msg;
      document.getElementById('toast-container').appendChild(t);
      setTimeout(() => t.remove(), 5000);
    }

    function showModal(id) { document.getElementById(id).classList.add('active'); loadOrgSelects(); }
    function hideModal(id) { document.getElementById(id).classList.remove('active'); }

    async function loadStats() {
      try {
        const r = await fetch(`${API}/admin/stats`);
        const d = await r.json();
        if (d.success) {
          document.getElementById('stat-orgs').textContent = d.stats.organizations;
          document.getElementById('stat-assistants').textContent = d.stats.assistants;
          document.getElementById('stat-conversations').textContent = d.stats.conversations;
        }
      } catch (e) { console.error(e); }
    }

    async function loadOrgs() {
      try {
        const r = await fetch(`${API}/admin/organizations`);
        const d = await r.json();
        if (d.success) {
          orgsCache = d.organizations;
          document.getElementById('orgs-table').innerHTML = d.organizations.map(o => `
            <tr><td class="px-6 py-4 font-medium">${o.name}</td><td class="px-6 py-4">${o.slug}</td><td class="px-6 py-4">$${o.flat_rate_fee}</td><td class="px-6 py-4"><code class="text-xs bg-gray-100 px-2 py-1 rounded">${o.id.slice(0,8)}...</code><button onclick="navigator.clipboard.writeText('${o.id}');showToast('Copied!')" class="ml-2 text-purple-600"><i class="fas fa-copy"></i></button></td></tr>
          `).join('');
        }
      } catch (e) { showToast('Failed to load', 'error'); }
    }

    async function loadAssistants() {
      try {
        const r = await fetch(`${API}/admin/assistants`);
        const d = await r.json();
        if (d.success) {
          assistantsCache = d.assistants;
          document.getElementById('assistants-table').innerHTML = d.assistants.map(a => `
            <tr><td class="px-6 py-4 font-medium">${a.friendly_name}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs ${a.bot_type === 'voice' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">${a.bot_type}</span></td><td class="px-6 py-4">${a.model}</td><td class="px-6 py-4">${a.phone_number || '-'}</td><td class="px-6 py-4"><code class="text-xs bg-gray-100 px-2 py-1 rounded">${a.id.slice(0,8)}...</code><button onclick="navigator.clipboard.writeText('${a.id}');showToast('Copied!')" class="ml-2 text-purple-600"><i class="fas fa-copy"></i></button></td><td class="px-6 py-4"><button onclick="testAssistant('${a.id}')" class="text-green-600"><i class="fas fa-play"></i> Test</button></td></tr>
          `).join('');
        }
      } catch (e) { showToast('Failed to load', 'error'); }
    }

    async function loadOrgSelects() {
      if (!orgsCache.length) { const r = await fetch(`${API}/admin/organizations`); const d = await r.json(); if (d.success) orgsCache = d.organizations; }
      const opts = orgsCache.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
      ['kb-org-select', 'kb-text-org-select', 'assistant-org'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = `<option value="">Select...</option>${opts}`; });
    }

    async function loadChatAssistants() {
      if (!assistantsCache.length) { const r = await fetch(`${API}/admin/assistants`); const d = await r.json(); if (d.success) assistantsCache = d.assistants; }
      document.getElementById('chat-assistant-select').innerHTML = `<option value="">Select...</option>` + assistantsCache.filter(a => a.bot_type === 'chat').map(a => `<option value="${a.id}">${a.friendly_name}</option>`).join('');
    }

    document.getElementById('drop-zone')?.addEventListener('click', () => document.getElementById('kb-file').click());
    document.getElementById('kb-file')?.addEventListener('change', e => document.getElementById('file-name').textContent = e.target.files[0]?.name || '');

    document.getElementById('org-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const r = await fetch(`${API}/admin/organizations`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: document.getElementById('org-name').value, slug: document.getElementById('org-slug').value, flat_rate_fee: parseFloat(document.getElementById('org-fee').value), included_interactions: parseInt(document.getElementById('org-included').value) }) });
        const d = await r.json();
        if (d.success) { showToast(`Created! UUID: ${d.organization.id}`); hideModal('org-modal'); e.target.reset(); loadOrgs(); loadStats(); } else showToast(d.error, 'error');
      } catch (err) { showToast('Failed', 'error'); }
    });

    document.getElementById('assistant-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const type = document.querySelector('input[name="bot-type"]:checked').value;
      try {
        const r = await fetch(`${API}/admin/assistants`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ org_id: document.getElementById('assistant-org').value, friendly_name: document.getElementById('assistant-name').value, bot_type: type, phone_number: type === 'voice' ? document.getElementById('assistant-phone').value : null, elevenlabs_voice_id: type === 'voice' ? document.getElementById('assistant-voice').value : null, model: document.getElementById('assistant-model').value, prompt: document.getElementById('assistant-prompt').value }) });
        const d = await r.json();
        if (d.success) { showToast(`Created! UUID: ${d.assistant.id}`); hideModal('assistant-modal'); e.target.reset(); loadAssistants(); loadStats(); } else showToast(d.error, 'error');
      } catch (err) { showToast('Failed', 'error'); }
    });

    document.getElementById('kb-upload-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('kb-file').files[0];
      if (!file) { showToast('Select file', 'error'); return; }
      const fd = new FormData(); fd.append('file', file); fd.append('org_id', document.getElementById('kb-org-select').value);
      try {
        const r = await fetch(`${API}/admin/knowledge-base/upload`, { method: 'POST', body: fd });
        const d = await r.json();
        if (d.success) { showToast(d.message); e.target.reset(); document.getElementById('file-name').textContent = ''; } else showToast(d.error, 'error');
      } catch (err) { showToast('Failed', 'error'); }
    });

    document.getElementById('kb-text-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const r = await fetch(`${API}/admin/knowledge-base/text`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ org_id: document.getElementById('kb-text-org-select').value, title: document.getElementById('kb-title').value, text: document.getElementById('kb-text').value }) });
        const d = await r.json();
        if (d.success) { showToast(d.message); e.target.reset(); } else showToast(d.error, 'error');
      } catch (err) { showToast('Failed', 'error'); }
    });

    function toggleVoice() { document.getElementById('voice-fields').classList.toggle('hidden', document.querySelector('input[name="bot-type"]:checked').value !== 'voice'); }

    async function validatePhone() {
      const p = document.getElementById('assistant-phone').value, s = document.getElementById('phone-status');
      s.textContent = 'Validating...'; s.className = 'text-sm mt-1 text-gray-500';
      try {
        const r = await fetch(`${API}/admin/validate-twilio-number`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone_number: p }) });
        const d = await r.json();
        s.textContent = d.valid ? 'Valid!' : (d.error || 'Invalid'); s.className = `text-sm mt-1 ${d.valid ? 'text-green-600' : 'text-red-600'}`;
      } catch (err) { s.textContent = 'Error'; s.className = 'text-sm mt-1 text-red-600'; }
    }

    function startNewChat() { chatSessionId = null; chatCost = 0; document.getElementById('chat-messages').innerHTML = '<p class="text-center text-gray-500">Start chatting</p>'; document.getElementById('chat-session').textContent = '-'; document.getElementById('chat-cost').textContent = '0.000'; }

    async function sendChat() {
      const aid = document.getElementById('chat-assistant-select').value, input = document.getElementById('chat-input'), msg = input.value.trim();
      if (!aid) { showToast('Select assistant', 'error'); return; }
      if (!msg) return;
      const cont = document.getElementById('chat-messages');
      if (cont.querySelector('p.text-gray-500')) cont.innerHTML = '';
      cont.innerHTML += `<div class="max-w-[80%] ml-auto rounded-lg px-4 py-2 gradient-bg text-white">${msg}</div>`;
      input.value = ''; cont.scrollTop = cont.scrollHeight;
      try {
        const r = await fetch(`${API}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ assistantId: aid, sessionId: chatSessionId, message: msg }) });
        const d = await r.json();
        if (d.sessionId) chatSessionId = d.sessionId;
        chatCost += d.cost || 0;
        cont.innerHTML += `<div class="max-w-[80%] rounded-lg px-4 py-2 bg-gray-200">${d.response}</div>`;
        cont.scrollTop = cont.scrollHeight;
        document.getElementById('chat-session').textContent = chatSessionId?.slice(0,8) + '...' || '-';
        document.getElementById('chat-cost').textContent = chatCost.toFixed(6);
      } catch (err) { cont.innerHTML += `<div class="max-w-[80%] rounded-lg px-4 py-2 bg-red-100 text-red-800">Error: ${err.message}</div>`; }
    }

    function testAssistant(id) { document.getElementById('chat-assistant-select').value = id; navigateTo('chat'); startNewChat(); }

    async function checkBackend() {
      try {
        const r = await fetch(API.replace('/api', '') + '/health');
        const d = await r.json();
        document.getElementById('backendStatus').textContent = d.status === 'healthy' ? 'Connected' : 'Error';
        document.getElementById('backendStatus').className = d.status === 'healthy' ? 'text-green-300' : 'text-red-300';
      } catch (e) { document.getElementById('backendStatus').textContent = 'Disconnected'; document.getElementById('backendStatus').className = 'text-red-300'; }
    }

    checkBackend(); loadStats(); setInterval(checkBackend, 30000);
  </script>
</body>
</html>
